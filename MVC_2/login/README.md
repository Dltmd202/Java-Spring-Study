# 로그인 처리 - 쿠키, 세션



### 로그인 요구사항
* 홈 화면 - 로그인 전 
  * 회원 가입
  * 로그인
* 홈 화면 - 로그인 후
  * 본인 이름(누구님 환영합니다.) 
  * 상품 관리
  * 로그 아웃
* 보안 요구사항
  * 로그인 사용자만 상품에 접근하고, 관리할 수 있음
  * 로그인 하지 않은 사용자가 상품 관리에 접근하면 로그인 화면으로 이동
* 회원 가입, 상품 관리


### 패키지 구조 설계

#### package 구조 
* hello.login
  * domain 
    * item
    * member
    * login 
  * web
    * item 
    * member 
    * login


### 로그인 처리하기 - 쿠키 사용

#### 로그인 상태 유지하기

##### 쿠키

서버에서 로그인에 성공하면 HTTP 응답에 쿠키를 담아서 브라우저에 전달 그러면 브라우저는 앞으로 해당 쿠키를 지속해서 보내준다.

#### 쿠키 생성

![](./res/1.png)

#### 클라이언트 쿠키 전달

![](./res/2.png)

![](./res/3.png)

#### 쿠키에는 영속 쿠키와 세션 쿠키가 있다.

* 영속 쿠키: 만료 날짜를 입력하면 해당 날짜까지 유지 
* 세션 쿠키: 만료 날짜를 생략하면 브라우저 종료시 까지만 유지

#### 쿠키 생성 로직

```java
Cookie idCookie = new Cookie("memberId", String.valueOf(loginMember.getId()));
response.addCookie(idCookie);
```

로그인에 성공하면 쿠키를 생성하고 `HttpServletResponse` 에 담는다. 
쿠키 이름은 `memberId` 이고, 값은 회원의 `id`를담아둔다. 웹브라우저는 종료 전까지 회원의 `id`를 서버에 계속 보내줄 것이다.

### 쿠키와 보안 문제

쿠키를 사용해서 로그인Id를 전달해서 로그인을 유지할 수 있었다. 그런데 여기에는 심각한 보안 문제가 있다.

#### 보안 문제
* 쿠키 값은 임의로 변경할 수 있다.
  * 클라이언트가 쿠키를 강제로 변경하면 다른 사용자가 된다.
  * 실제 웹브라우저 개발자모드 Application Cookie 변경으로 확인
  * `Cookie: memberId=1` -> `Cookie: memberId=2` (다른 사용자의 이름이 보임) 
* 쿠키에 보관된 정보는 훔쳐갈 수 있다.
  * 만약 쿠키에 개인정보나, 신용카드 정보가 있다면?
  * 이 정보가 웹 브라우저에도 보관되고, 네트워크 요청마다 계속 클라이언트에서 서버로 전달된다. 
  * 쿠키의 정보가 나의 로컬 PC가 털릴 수도 있고, 네트워크 전송 구간에서 털릴 수도 있다.
* 해커가 쿠키를 한번 훔쳐가면 평생 사용할 수 있다.
  * 해커가 쿠키를 훔쳐가서 그 쿠키로 악의적인 요청을 계속 시도할 수 있다.

#### 대안

* 쿠키에 중요한 값을 노출하지 않고, 사용자 별로 예측 불가능한 임의의 토큰(랜덤 값)을 노출하고, 
  서버에서 토큰과 사용자 id를 매핑해서 인식한다. 그리고 서버에서 토큰을 관리한다.
* 토큰은 해커가 임의의 값을 넣어도 찾을 수 없도록 예상 불가능 해야 한다.
* 해커가 토큰을 털어가도 시간이 지나면 사용할 수 없도록 서버에서 해당 토큰의 만료시간을 짧게(예: 30분) 유지한다. 
  또는 해킹이 의심되는 경우 서버에서 해당 토큰을 강제로 제거하면 된다.


### 로그인 처리하기 - 세션 동작 방식

앞서 쿠키에 중요한 정보를 보관하는 방법은 여러가지 보안 이슈가 있었다. 
이 문제를 해결하려면 결국 중요한 정보를 모두 서버에 저장해야 한다. 그리고 클라이언트와 서버는 추정 불가능한 임의의 식별자 값으로 연결해야 한다.

#### 세션 동작 방식

##### 로그인

![](./res/4.png)

* 사용자가 `loginId` , `password` 정보를 전달하면 서버에서 해당 사용자가 맞는지 확인한다.

![](./res/5.png)

* 세션 ID를 생성하는데, 추정 불가능해야 한다. 
* **UUID는 추정이 불가능하다.**
  * `Cookie: mySessionId=zz0101xx-bab9-4b92-9b32-dadb280f4b61` 
* 생성된 세션 ID와 세션에 보관할 값( `memberA` )을 서버의 세션 저장소에 보관한다.

##### 세션 id를 응답 쿠키로 전달

![](./res/6.png)

#### 클라이언트와 서버는 결국 쿠키로 연결이 되어야 한다.
* 서버는 클라이언트에 `mySessionId` 라는 이름으로 세션ID 만 쿠키에 담아서 전달한다. 
* 클라이언트는 쿠키 저장소에 `mySessionId` 쿠키를 보관한다.

#### 중요
* 여기서 중요한 포인트는 회원과 관련된 정보는 전혀 클라이언트에 전달하지 않는다는 것이다. 
* 오직 추정 불가능한 세션 ID만 쿠키를 통해 클라이언트에 전달한다.

#### 클라이언트의 세션id 쿠키 전달

![](./res/7.png)

* 클라이언트는 요청시 항상 `mySessionId` 쿠키를 전달한다.
* 서버에서는 클라이언트가 전달한 `mySessionId` 쿠키 정보로 세션 저장소를 조회해서 로그인시 보관한 세션 정보를 사용한다.


### 로그인 처리하기 - 세션 직접 만들기 세션을 직접 개발해서 적용해보자.

세션 관리는 크게 다음 3가지 기능을 제공하면 된다.

#### 세션 생성

* sessionId 생성 (임의의 추정 불가능한 랜덤 값
* 세션 저장소에 sessionId와 보관할 값 저장
* sessionId로 응답 쿠키를 생성해서 클라이언트에 전달 

#### 세션 조회

* 클라이언트가 요청한 sessionId 쿠키의 값으로, 세션 저장소에 보관한 값 조회 

#### 세션 만료

* 클라이언트가 요청한 sessionId 쿠키의 값으로, 세션 저장소에 보관한 sessionId와 값 제거